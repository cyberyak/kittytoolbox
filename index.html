<!DOCTYPE html>
<html>

<head>
<title>Kitty-Toolbox - Rarity Calculation</title>
<script src="bundle.js"></script>
<script src="cattributes.js"></script>
<style>
img {
  vertical-align: middle;
  }
.row {
  border: 1px solid gray;
}
.inline {
  display: inline-block;
  vertical-align: middle;
  padding-right: 20px;
}
</style>
</head>

<body>
<h1>CryptoKitties - Cat Rarity Calculator</h1>
<div id='console'></div>
<div id='loader' style="width: 100%; height: 100px; display: none"><span style="display: inline-block; height: 100%; vertical-align: middle"></span><img src="ajax-loader.gif" style="margin-left: 150px; vertical-align: middle"></div>
<div style="margin-top: 20px">
KittyId: <input id="kittyId"/>
<button onclick="getRarity()">Get Rarity</button>
<button onclick="c.cls()">Clear</button>
</div>
</body>

<script>
const node = document.getElementById("kittyId");
node.addEventListener('keydown', function(event) {
    if (event.key === "Enter") {
        getRarity()
	node.value = ""
    }
});

/* console.log function from: http://www.kobashicomputing.com/send-your-console-output-to-the-result-pane-in-jsfiddle */
var c = function() {
    return({
        log: function(img, line1, line2) {
          consoleDiv = document.getElementById('console');
          image = document.createElement('img');
          image.src = img
          image.width = 100
          image.height = 100

          div = document.createElement('div');
          div.classList.add('row');
          imgdiv = document.createElement('div');
          imgdiv.classList.add('inline');
          textdiv = document.createElement('div');
          textdiv.classList.add('inline');
          para1 = document.createElement('p');
          para2 = document.createElement('p');
          text1 = document.createTextNode(line1);
          text2 = document.createTextNode(line2);

          imgdiv.appendChild(image);
          para1.appendChild(text1);
          
          b = document.createElement('b');
          b.appendChild(text2);
          para2.appendChild(b);
          textdiv.appendChild(para1);
          textdiv.appendChild(para2);
          
          div.appendChild(imgdiv);
          div.appendChild(textdiv);

          consoleDiv.appendChild(div);
        },
        cls: function(msg) {
          consoleDiv = document.getElementById('console');
          consoleDiv.innerHTML='';
        }
    });
}();

var totalKitties = 133992

function getRarity() {
  var kittyId = document.getElementById("kittyId").value;
  document.getElementById("loader").style = "width: 100%; height: 100px; display: block;";


  myBundle.getKittyCS(kittyId, (error, cat) => {
    c.log(cat.image_url, `#${kittyId} - ${cat.name}
                       - GEN:${cat.generation}
                       - Cooldown:${cat.status.cooldown_index}`,
                       `RARITY: ${(calculateRarity(cat)*100*100000).toFixed(2)}% === ` + printCattributes(cat))
    document.getElementById("loader").style = "width: 100%; height: 100px; display: none;";
  })
}

function printCattributes(cat) {
  catrSorted = []

  if (cat.cattributes.length > 0) {
    cat.cattributes.forEach((cattribute) => {
      description = cattribute.description
      rarity = (cattributes[cattribute.description]/totalKitties*100).toFixed(2)
      catrSorted.push({description: description, rarity: rarity})
    })

    catrSorted.sort((a,b) => {
      return a.rarity-b.rarity
    })
    
    var str = ""
    catrSorted.forEach((cattribute) => {
      str += cattribute.description + ` (${cattribute.rarity}%) - `
    })
    return str.substring(0, str.length-3)
  } else {
    return "- FANCY!"
  }
}

function calculateRarity(cat) {
  var rarity = 1;
  cat.cattributes.forEach((cattribute) => {
    rarity = rarity * cattributes[cattribute.description]/totalKitties
  })
  if (rarity == 1) return 0;
  return rarity
}

</script>

</html>